<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dad's 75th - Deal or No Deal Game</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Optional loading overlay -->
  <div id="loadingOverlay">Loading...</div>
  
  <h1>Dad's 75th</h1>
  <h1>Deal or No Deal</h1>

  <!-- Birthday Photo Section -->
  <div id="birthdayPhoto">
    <img src="images/dad75.jpg" alt="Dad's 75th Birthday">
  </div>
  
  <!-- Grid of briefcases (all boxes remain visible) -->
  <div id="briefcasesContainer"></div>
  
  <div class="container" id="gameContainer">
    <!-- Main game area -->
    <div id="gameArea">
      <div id="roundIndicator">Round: 1</div>
      <!-- Dedicated container for banker's offer / final decision -->
      <div id="offerContainer"></div>
      <p class="message" id="gameMessage">
        Click a briefcase to choose your personal box.
      </p>
    </div>
    <!-- Side panel: Prize board and bank offers history -->
    <div id="rightArea">
      <h2>Prizes</h2>
      <ul id="prizeBoard"></ul>
      <h2>Previous Bank Offers</h2>
      <ul id="offersHistory"></ul>
    </div>
  </div>
  
  <!-- Fireworks container -->
  <div id="fireworksContainer"></div>
  
  <!-- Audio elements -->
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>
  <audio id="offerSound" src="offer.mp3" preload="auto"></audio>
  <audio id="declineSound" src="decline.mp3" preload="auto"></audio>
  <!-- Background music -->
  <audio id="bgMusic" src="music.mp3" loop preload="auto"></audio>
  <!-- Applause sound -->
  <audio id="applause" src="applause.mp3" preload="auto"></audio>
  
  <script>
    // ----- Data Setup -----
    const prizes = [0.01, 1, 5, 10, 25, 50, 75, 100, 125, 150, 175, 200, 250, 300, 350, 400, 450, 500];
    const boxes = Array.from({ length: 18 }, (_, i) => i + 1);
    let boxValues = {};
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    shuffle(prizes);
    boxes.forEach((box, index) => {
      boxValues[box] = prizes[index];
    });
    
    // ----- Random Image Assignment -----
    const images = Array.from({ length: 18 }, (_, i) => `images/${i + 1}.jpg`);
    shuffle(images);
    const boxImages = {};
    boxes.forEach((box, index) => {
      boxImages[box] = images[index];
    });
    
    // ----- Game State Variables -----
    let chosenBox = null;           // Personal box (contents hidden until final reveal)
    let openedStatus = {};          // Tracks which boxes have been opened
    let valuesRemaining = prizes.slice();
    let currentRound = 0;
    const rounds = [4, 3, 3, 2, 2, 1, 1, 1, 1];  // Number of briefcases to open per round
    let openedCount = 0;
    let offersHistory = [];
    let offerActive = false;
    
    // ----- Rendering Functions -----
    function renderBriefcases() {
      const container = document.getElementById('briefcasesContainer');
      container.innerHTML = "";
      boxes.forEach(box => {
        // Always render all briefcases; opened boxes will display their prize.
        const briefcase = document.createElement("div");
        briefcase.className = "briefcase";
        briefcase.id = "briefcase-" + box;
        if (box === chosenBox) {
          briefcase.innerHTML = `<img class="briefcase-img" src="${boxImages[box]}" alt="Image ${box}">
                                  <div class="briefcase-number">${box}</div>`;
          briefcase.classList.add("personal");
        } else if (openedStatus[box]) {
          briefcase.innerHTML = `<img class="briefcase-img" src="${boxImages[box]}" alt="Image ${box}">
                                  <div class="briefcase-number">$${boxValues[box].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>`;
          briefcase.classList.add("opened");
        } else {
          briefcase.innerHTML = `<img class="briefcase-img" src="${boxImages[box]}" alt="Image ${box}">
                                  <div class="briefcase-number">${box}</div>`;
        }
        briefcase.onclick = function () {
          if (offerActive) { return; }
          if (openedStatus[box] || box === chosenBox) { return; }
          playSound('clickSound');
          briefcaseClicked(box);
        };
        container.appendChild(briefcase);
      });
      // Check final swap condition: if only one unopened box remains (besides personal box), trigger final swap.
      const unopened = boxes.filter(b => !openedStatus[b] && b !== chosenBox);
      if (unopened.length === 1) {
        setTimeout(() => { finalSwap(); }, 500);
      }
    }
    
    function updatePrizeBoard() {
      const prizeBoard = document.getElementById('prizeBoard');
      const sortedPrizes = [...prizes].sort((a, b) => a - b);
      prizeBoard.innerHTML = "";
      sortedPrizes.forEach(prize => {
        const li = document.createElement("li");
        li.textContent = "$" + prize.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        if (!valuesRemaining.includes(prize)) { li.className = "eliminated"; }
        prizeBoard.appendChild(li);
      });
    }
    
    function updateOffersHistory() {
      const historyList = document.getElementById('offersHistory');
      historyList.innerHTML = "";
      offersHistory.forEach((offer, index) => {
        const li = document.createElement("li");
        li.textContent = "Offer " + (index + 1) + ": $" + offer.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        historyList.appendChild(li);
      });
    }
    
    function updateSidePanels() {
      updatePrizeBoard();
      updateOffersHistory();
    }
    
    function updateRoundIndicator() {
      document.getElementById("roundIndicator").textContent = "Round: " + (currentRound + 1);
    }
    
    function updateGameArea(htmlContent) {
      const gameArea = document.getElementById('gameArea');
      gameArea.innerHTML = htmlContent;
      // Re-add an empty offer container so that offerDeal() can update it later.
      const offerDiv = document.createElement("div");
      offerDiv.id = "offerContainer";
      gameArea.insertBefore(offerDiv, gameArea.children[1]);
      updateSidePanels();
    }
    
    // ----- Game Functions -----
    function briefcaseClicked(box) {
      if (!chosenBox) {
        chosenBox = box;
        document.getElementById("gameMessage").textContent =
          "You have chosen box #" + box + " as your personal box. Now open other boxes by clicking on them.";
        renderBriefcases();
      } else {
        if (box === chosenBox) { return; }
        if (openedStatus[box]) { return; }
        openBriefcase(box);
      }
      updateSidePanels();
      updateRoundIndicator();
    }
    
    function openBriefcase(box) {
      openedStatus[box] = true;
      const briefcase = document.getElementById("briefcase-" + box);
      let clone = briefcase.cloneNode(true);
      clone.innerHTML = `<img class="center-img" src="${boxImages[box]}" alt="Image ${box}">
                         <div class="center-amount">$${boxValues[box].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>`;
      clone.classList.add("center-open");
      document.body.appendChild(clone);
      
      const idx = valuesRemaining.indexOf(boxValues[box]);
      if (idx > -1) { valuesRemaining.splice(idx, 1); }
      renderBriefcases();
      
      openedCount++;
      if (openedCount >= rounds[currentRound]) {
        offerActive = true;
        playSound('offerSound');
        setTimeout(() => {
          offerDeal();
          currentRound++;
          openedCount = 0;
          updateRoundIndicator();
        }, 1000);
      }
      
      const unopened = boxes.filter(b => !openedStatus[b] && b !== chosenBox);
      if (unopened.length === 1) {
        setTimeout(() => { finalSwap(); }, 500);
        return;
      }
      
      // Blown-up clone animation lasts 19 seconds.
      setTimeout(() => { clone.remove(); }, 19000);
    }
    
    function finalSwap() {
      // Final decision displayed in the offer container.
      offerActive = true;
      document.getElementById("offerContainer").innerHTML = `
        <p class="message">Final decision: Do you want to keep your personal box or swap it with the last remaining briefcase?</p>
        <button onclick="keepBox()">Keep My Box</button>
        <button onclick="swapBox()">Swap Box</button>
      `;
    }
    
    function keepBox() {
      updateGameArea(`
        <p class="message">You kept your personal box (#${chosenBox}). It contains: $${boxValues[chosenBox].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <button onclick="playAgain()">Play Again</button>
      `);
      playSound('applause');
      launchFireworks();
    }
    
    function swapBox() {
      const unopened = boxes.filter(b => !openedStatus[b] && b !== chosenBox);
      const swapBox = unopened[0];
      chosenBox = swapBox;
      updateGameArea(`
        <p class="message">You swapped your box. Your new box (#${chosenBox}) contains: $${boxValues[chosenBox].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <button onclick="playAgain()">Play Again</button>
      `);
      playSound('applause');
      launchFireworks();
    }
    
    function getBankersOffer(values) {
      const sum = values.reduce((acc, curr) => acc + curr, 0);
      return sum / values.length;
    }
    
    function offerDeal() {
      const offer = getBankersOffer(valuesRemaining);
      offersHistory.push(offer);
      const offerContainer = document.getElementById("offerContainer");
      offerContainer.innerHTML = `<p class="message">Incoming call from the banker...</p>`;
      setTimeout(() => {
        offerContainer.innerHTML = `
          <p class="message">The banker offers you: $${offer.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          <p class="message">Deal or No Deal?</p>
          <button onclick="acceptDeal(${offer})">Deal</button>
          <button onclick="declineDeal()">No Deal</button>
        `;
      }, 5000);
    }
    
    function acceptDeal(offer) {
      updateGameArea(`
        <p class="message">You accepted the deal of $${offer.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}!</p>
        <p class="message">Your personal box (#${chosenBox}) contained: $${boxValues[chosenBox].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <button onclick="playAgain()">Play Again</button>
      `);
      playSound('applause');
      launchFireworks();
    }
    
    function declineDeal() {
      playSound('declineSound');
      offerActive = true;
      let countdown = 2;
      const offerElem = document.getElementById("offerContainer");
      const interval = setInterval(() => {
        offerElem.innerText = `Continuing in ${countdown}...`;
        countdown--;
        if (countdown < 0) {
          clearInterval(interval);
          offerElem.innerHTML = "";
          offerActive = false;
          document.getElementById("gameMessage").innerText = "Continue opening boxes by clicking on them.";
          renderBriefcases();
          updateSidePanels();
        }
      }, 1000);
    }
    
    function launchFireworks() {
      const container = document.getElementById("fireworksContainer");
      container.innerHTML = "";
      const duration = 30000;
      const endTime = Date.now() + duration;
      const interval = setInterval(() => {
        if (Date.now() > endTime) { clearInterval(interval); return; }
        const firework = document.createElement("div");
        firework.className = "firework";
        firework.style.left = Math.random() * 100 + "vw";
        firework.style.top = Math.random() * 100 + "vh";
        container.appendChild(firework);
        setTimeout(() => { firework.remove(); }, 1500);
      }, 200);
    }
    
    function updateGameArea(htmlContent) {
      const gameArea = document.getElementById('gameArea');
      gameArea.innerHTML = htmlContent;
      const offerDiv = document.createElement("div");
      offerDiv.id = "offerContainer";
      gameArea.insertBefore(offerDiv, gameArea.children[1]);
      updateSidePanels();
    }
    
    function playAgain() {
      window.location.reload();
    }
    
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(err => console.log("Sound error: " + err));
      }
    }
    
    // ----- Initial Rendering -----
    window.onload = function() {
      document.getElementById("loadingOverlay").style.display = "none";
      renderBriefcases();
      updateSidePanels();
      updateRoundIndicator();
      // Start background music on load (or on first click if autoplay is blocked)
      const bgMusic = document.getElementById("bgMusic");
      if (bgMusic) {
        bgMusic.volume = 0.3;
        bgMusic.play().catch(err => {
          console.log("Background music autoplay error: " + err);
          document.body.addEventListener('click', function startBgMusic() {
            bgMusic.play().catch(err => console.log("Background music error on click: " + err));
            document.body.removeEventListener('click', startBgMusic);
          });
        });
      }
    };
  </script>
</body>
</html>
