<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dad's 75th - Deal or No Deal Game</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Optional loading overlay -->
  <div id="loadingOverlay">Loading...</div>
  
  <h1>Dad's 75th</h1>
  <h1>Deal or No Deal</h1>

  <!-- Birthday Photo Section -->
  <div id="birthdayPhoto">
    <img src="images/dad75.jpg" alt="Dad's 75th Birthday">
  </div>
  
  <!-- Grid of briefcases -->
  <div id="briefcasesContainer"></div>
  
  <div class="container" id="gameContainer">
    <!-- Main game area -->
    <div id="gameArea">
      <div id="roundIndicator">Round: 1</div>
      <!-- Container for bank offer (populated when an offer is made) -->
      <div id="offerContainer"></div>
      <!-- Game message remains separate -->
      <p class="message" id="gameMessage">
        Click a briefcase to choose your personal box.
      </p>
    </div>
    <!-- Side panel: Prize board and bank offers history -->
    <div id="rightArea">
      <h2>Prizes</h2>
      <ul id="prizeBoard"></ul>
      <h2>Previous Bank Offers</h2>
      <ul id="offersHistory"></ul>
    </div>
  </div>
  
  <!-- Fireworks container (if needed) -->
  <div id="fireworksContainer"></div>
  
  <!-- Audio elements for sound effects -->
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>
  <audio id="offerSound" src="offer.mp3" preload="auto"></audio>
  
  <script>
    // ----- Data Setup -----
    const prizes = [0.01, 1, 5, 10, 25, 50, 75, 100, 125, 150, 175, 200, 250, 300, 350, 400, 450, 500];
    const boxes = Array.from({ length: 18 }, (_, i) => i + 1);
    let boxValues = {};
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    shuffle(prizes);
    boxes.forEach((box, index) => {
      boxValues[box] = prizes[index];
    });
    
    // ----- Random Image Assignment -----
    // Images stored in "images" folder named "1.jpg" to "18.jpg"
    const images = Array.from({ length: 18 }, (_, i) => `images/${i + 1}.jpg`);
    shuffle(images);
    const boxImages = {};
    boxes.forEach((box, index) => {
      boxImages[box] = images[index];
    });
    
    // ----- Game State Variables -----
    let chosenBox = null;           // Player's personal box (contents remain hidden until final reveal)
    let openedStatus = {};          // Track which boxes have been opened (except personal)
    let valuesRemaining = prizes.slice();
    let currentRound = 0;
    const rounds = [4, 3, 3, 2, 2, 1, 1, 1, 1];  // Number of briefcases to open per round
    let openedCount = 0;
    let offersHistory = [];
    let offerActive = false;
    
    // ----- Rendering Functions -----
    function renderBriefcases() {
      const container = document.getElementById('briefcasesContainer');
      container.innerHTML = "";
      boxes.forEach(box => {
        const briefcase = document.createElement("div");
        briefcase.className = "briefcase";
        briefcase.id = "briefcase-" + box;
        if (box === chosenBox) {
          // Personal box: highlighted (gold overlay) but still closed.
          briefcase.innerHTML = `<img class="briefcase-img" src="${boxImages[box]}" alt="Image ${box}">
                                  <div class="briefcase-number">${box}</div>`;
          briefcase.classList.add("personal");
        } else if (openedStatus[box]) {
          // Opened box: show prize amount.
          briefcase.innerHTML = `<img class="briefcase-img" src="${boxImages[box]}" alt="Image ${box}">
                                  <div class="briefcase-number">$${boxValues[box].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>`;
          briefcase.classList.add("opened");
        } else {
          // Unopened box.
          briefcase.innerHTML = `<img class="briefcase-img" src="${boxImages[box]}" alt="Image ${box}">
                                  <div class="briefcase-number">${box}</div>`;
        }
        briefcase.onclick = function () {
          if (offerActive) { return; }
          if (openedStatus[box] || box === chosenBox) { return; }
          playSound('clickSound');
          briefcaseClicked(box);
        };
        container.appendChild(briefcase);
      });
    }
    
    function updatePrizeBoard() {
      const prizeBoard = document.getElementById('prizeBoard');
      const sortedPrizes = [...prizes].sort((a, b) => a - b);
      prizeBoard.innerHTML = "";
      sortedPrizes.forEach(prize => {
        const li = document.createElement("li");
        li.textContent = "$" + prize.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        if (!valuesRemaining.includes(prize)) { li.className = "eliminated"; }
        prizeBoard.appendChild(li);
      });
    }
    
    function updateOffersHistory() {
      const historyList = document.getElementById('offersHistory');
      historyList.innerHTML = "";
      offersHistory.forEach((offer, index) => {
        const li = document.createElement("li");
        li.textContent = "Offer " + (index + 1) + ": $" + offer.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        historyList.appendChild(li);
      });
    }
    
    function updateSidePanels() {
      updatePrizeBoard();
      updateOffersHistory();
    }
    
    function updateRoundIndicator() {
      document.getElementById("roundIndicator").textContent = "Round: " + (currentRound + 1);
    }
    
    // ----- Game Functions -----
    function briefcaseClicked(box) {
      if (!chosenBox) {
        chosenBox = box;
        document.getElementById("gameMessage").textContent =
          "You have chosen box #" + box + " as your personal box. Now open other boxes by clicking on them.";
        renderBriefcases();
      } else {
        if (box === chosenBox) { return; }
        if (openedStatus[box]) { return; }
        openBriefcase(box);
      }
      updateSidePanels();
      updateRoundIndicator();
    }
    
    function openBriefcase(box) {
      openedStatus[box] = true;
      const briefcase = document.getElementById("briefcase-" + box);
      let clone = briefcase.cloneNode(true);
      clone.innerHTML = `<img class="center-img" src="${boxImages[box]}" alt="Image ${box}">
                         <div class="center-amount">$${boxValues[box].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>`;
      clone.classList.add("center-open");
      document.body.appendChild(clone);
      
      const idx = valuesRemaining.indexOf(boxValues[box]);
      if (idx > -1) { valuesRemaining.splice(idx, 1); }
      renderBriefcases();
      
      openedCount++;
      if (openedCount >= rounds[currentRound]) {
        offerActive = true;
        playSound('offerSound');
        setTimeout(() => {
          offerDeal();
          currentRound++;
          openedCount = 0;
          updateRoundIndicator();
        }, 1000);
      }
      
      const unopened = boxes.filter(b => !openedStatus[b] && b !== chosenBox);
      if (unopened.length === 1) {
        setTimeout(() => { finalSwap(); }, 1000);
      }
      
      // Blown-up clone animation lasts 19 seconds (approx 1.9s to blow up, 15s hold, 1.9s shrink)
      setTimeout(() => { clone.remove(); }, 19000);
    }
    
    function finalSwap() {
      offerActive = true;
      updateGameArea(`
        <p class="message">Only one briefcase remains. Do you want to keep your personal box or swap it with the last briefcase?</p>
        <button onclick="keepBox()">Keep My Box</button>
        <button onclick="swapBox()">Swap Box</button>
      `, true);
    }
    
    function keepBox() {
      updateGameArea(`
        <p class="message">You kept your personal box (#${chosenBox}). It contains: $${boxValues[chosenBox].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <button onclick="playAgain()">Play Again</button>
      `);
    }
    
    function swapBox() {
      const unopened = boxes.filter(b => !openedStatus[b] && b !== chosenBox);
      const swapBox = unopened[0];
      chosenBox = swapBox;
      updateGameArea(`
        <p class="message">You swapped your box. Your new box (#${chosenBox}) contains: $${boxValues[chosenBox].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <button onclick="playAgain()">Play Again</button>
      `);
    }
    
    function getBankersOffer(values) {
      const sum = values.reduce((acc, curr) => acc + curr, 0);
      return sum / values.length;
    }
    
    function offerDeal() {
      const offer = getBankersOffer(valuesRemaining);
      offersHistory.push(offer);
      // Update only the offer container (preserving the gameMessage)
      document.getElementById("offerContainer").innerHTML = `
        <p class="message">The banker offers you: $${offer.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <p class="message">Deal or No Deal?</p>
        <button onclick="acceptDeal(${offer})">Deal</button>
        <button onclick="declineDeal()">No Deal</button>
      `;
    }
    
    function acceptDeal(offer) {
      updateGameArea(`
        <p class="message">You accepted the deal of $${offer.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}!</p>
        <p class="message">Your personal box (#${chosenBox}) contained: $${boxValues[chosenBox].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
        <button onclick="playAgain()">Play Again</button>
      `);
      launchFireworks();
    }
    
    // Modified declineDeal() that uses a countdown without removing the offer container
    function declineDeal() {
      // We keep the offer container as is, so the "No Deal" button remains clickable.
      // We then run a countdown (2 seconds) before clearing the offer container and re-enabling briefcase selection.
      offerActive = true; // Lock briefcase selection
      let countdown = 2;
      const msgElem = document.getElementById("gameMessage");
      const interval = setInterval(() => {
        msgElem.innerText = `You declined the offer. Continuing in ${countdown}...`;
        countdown--;
        if (countdown < 0) {
          clearInterval(interval);
          msgElem.innerText = "Continue opening boxes by clicking on them.";
          // Clear the offer container
          document.getElementById("offerContainer").innerHTML = "";
          offerActive = false;
          renderBriefcases();
          updateSidePanels();
        }
      }, 1000);
    }
    
    function launchFireworks() {
      const container = document.getElementById("fireworksContainer");
      container.innerHTML = "";
      const duration = 30000;
      const endTime = Date.now() + duration;
      const interval = setInterval(() => {
        if (Date.now() > endTime) { clearInterval(interval); return; }
        const firework = document.createElement("div");
        firework.className = "firework";
        firework.style.left = Math.random() * 100 + "vw";
        firework.style.top = Math.random() * 100 + "vh";
        container.appendChild(firework);
        setTimeout(() => { firework.remove(); }, 1500);
      }, 200);
    }
    
    function playAgain() {
      window.location.reload();
    }
    
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) {
        sound.currentTime = 0;
        sound.play();
      }
    }
    
    // ----- Initial Rendering -----
    window.onload = function() {
      document.getElementById("loadingOverlay").style.display = "none";
      renderBriefcases();
      updateSidePanels();
      updateRoundIndicator();
    };
    
    // Updated updateGameArea() that optionally preserves the offer container (for final swap, etc.)
    function updateGameArea(htmlContent, preserveOffer) {
      const gameArea = document.getElementById('gameArea');
      // If preserveOffer is true, only update the gameMessage; otherwise, update entire gameArea.
      if (preserveOffer) {
        document.getElementById("gameMessage").innerHTML = htmlContent;
      } else {
        gameArea.innerHTML = htmlContent;
      }
      updateSidePanels();
    }
  </script>
</body>
</html>
